@page "/products/shelves"

@inject ApiExtensions api
@inject VariablesExtensions app
@inject NavigationManager nav
@inject ShowDialog ShowDialog

@if(productsInShelves is null || loading)
{
    <Loading Message="Carregando produtos nas prateleiras..."></Loading>
}
else if(productsInShelves.Count == 0)
{
    <MudAlert Severity="Severity.Warning">Não há produtos alocados para venda nas prateleiras.</MudAlert>
}
else
{
    <MudTable Class="mt-3" Items="@productsInShelves" Dense="false" Hover="true" Bordered="false" Striped="true" Filter="new Func<EnterVO, bool>(FilterFuncAux)" RowsPerPage="100">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Produtos nas prateleiras para venda</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString" Placeholder="Pesquisar Produto" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Produto</MudTh>
            <MudTh>Preço</MudTh>
            <MudTh>Quantidade</MudTh>
            <MudTh>Prateleira</MudTh>
            <MudTh>Data de Entrada</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Produto">@context.ProductName</MudTd>
            <MudTd DataLabel="Preco">@context.ProductPrice</MudTd>
            <MudTd DataLabel="Quantidade">@context.ProductQuantity</MudTd>
            <MudTd DataLabel="Prateleira">@context.ShelfName</MudTd>
            <MudTd DataLabel="Data de Entrada">@context.DateEnter.ToString("dd/MM/yyyy HH:mm:ss")</MudTd>
            <MudTd DataLabel="Vender"><MudTooltip Text="Vender"><MudIconButton Icon="@Icons.Material.Filled.PointOfSale" Color="Color.Success" OnClick="@(() => SaleProduct(context.Id))"></MudIconButton></MudTooltip></MudTd>
            <MudTd DataLabel="Retornar alocacao"><MudTooltip Text="Enviar de volta para o estoque"><MudIconButton Icon="@Icons.Material.Filled.AssignmentReturn" Color="Color.Warning" OnClick="@(() => UndoAllocation(context.Id))"></MudIconButton></MudTooltip></MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager HideRowsPerPage="true"/>
        </PagerContent>
    </MudTable>
}

@code {

    #region Properties

    List<EnterVO>? productsInShelves = new();
    EnterVO? entry = new();

    string searchString = string.Empty;

    bool loading = false;

    #endregion

    #region Events

    protected override async Task OnInitializedAsync()
    {
        loading = true;

        if (app.ProductEntries is null || app.ProductEntries.Count() == 0)
            productsInShelves = await api.Get<EnterVO>();
        else
            productsInShelves = app.ProductEntries;

        if (productsInShelves is null)
            return;

        productsInShelves = productsInShelves.OrderBy(p => p.ProductQuantity == 0).ThenBy(p => p.ShelfName, StringComparer.OrdinalIgnoreCase).ToList();

        loading = false;
    }

    #endregion

    #region Methods

    private bool FilterFuncAux(EnterVO productsInShelves) => FilterFunc(productsInShelves, searchString);

    private bool FilterFunc(EnterVO productsInShelves, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (productsInShelves is null || string.IsNullOrWhiteSpace(productsInShelves.ProductName))
            return true;

        if (productsInShelves.ProductName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }

    private async void SaleProduct(int entryId)
    {
        if(productsInShelves is not null)
        {
            app.ActualEntry = productsInShelves.FirstOrDefault(e => e.Id.Equals(entryId));

            if (app.ActualEntry is not null)
                app.ActualProduct = await api.GetById<ProductVO>(app.ActualEntry.ProductId);

            nav.NavigateTo($"product/sale/{entryId}");
        }

    }

    private async void UndoAllocation(int entryId)
    {
        try
        {
            var confimation = await ShowDialog.ShowDialogAsync("Tem certeza que deseja cancelar a alocação? O produto será devolvido ao estoque.", "Confirmação", state: EDialogStates.Warning, showCancel: true, showYes: true);

            if (confimation)
            {
                entry = await api.GetById<EnterVO>(entryId);

                if (entry is null)
                    return;

                var result = await api.Put<EnterVO>(entry, entryId);

                await ReloadData();

                StateHasChanged();

                await ShowDialog.ShowDialogAsync("Alocação desfeita com sucesso.", "Sucesso", state:EDialogStates.Success); 
            }
        }
        catch (ApiException ex)
        {
            await ShowDialog.ShowDialogAsync($"Erro alocando o produto de volta para o estoque.\n{ex.Message}", "Erro", state: EDialogStates.Warning);
        }
    }

    private async Task ReloadData()
    {
        app.ProductEntries = new();
        app.ProductEntries = await api.Get<EnterVO>();

        if (app.ProductEntries is not null)
            productsInShelves = app.ProductEntries.OrderBy(p => p.ProductQuantity == 0).ThenBy(p => p.ShelfName, StringComparer.OrdinalIgnoreCase).ToList();
    }

    #endregion
}
