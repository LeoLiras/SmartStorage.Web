@page "/user/account"

@attribute [Authorize]

@using System.Text.RegularExpressions
@using System.Security.Claims
@using SmartStorage.Shared.Enum

@inject ApiExtensions api
@inject ShowDialog ShowDialog
@inject VariablesExtensions app
@inject AuthStateProvider auth

@if(app.User is null || loading)
{
    <Loading Message="Carregando..."></Loading>
}
else
{
    
    <EditUser UserId="app.User.Id" isAdm="isAdm"></EditUser>
    

    @if (isAdm)
    {
        <MudGrid Justify="Justify.Center">
            <MudItem xs="12" sm="12" xl="12">
                <div style="display: flex; flex-wrap: wrap;">
                    @if (PagedUsers is not null)
                    {
                        foreach (var user in PagedUsers)
                        {
                            <div style="margin: 10px;">
                                <MudCard Class="card-hover" Style="width: 250px; height: 230px;">
                                    <MudCardContent>
                                        <MudText Typo="Typo.h5">@user.FullName</MudText>
                                        <MudText Typo="Typo.body2">@user.Username</MudText>
                                        <MudText Typo="Typo.body2">Tipo: @(user.UseType == 0 ? "Usuário" : "Administrador")</MudText>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Class="m-2" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Edit" Color="Color.Success" OnClick="() => Edit(user.Id)">Editar</MudButton>
                                        <MudButton Class="m-2" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => Delete(user.Id)">Excluír</MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </div>
                        }
                    }
                </div>
            </MudItem>
            <MudItem>
                <MudPagination Color="Color.Info" Count="(int)Math.Ceiling((double)usersList.Count / (double)pageSize)" SelectedChanged="ChangePage" Class="mt-4" />
            </MudItem>
        </MudGrid>
    } 
}

@code {

    #region Propreties

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    ClaimsPrincipal? userAuth { get; set; }

    private List<User> usersList = new();

    bool loading = false;
    bool isAdm = false;

    private int currentPage = 1;
    private int pageSize = 10;

    private IEnumerable<User>? PagedUsers => usersList == null ? Enumerable.Empty<User>() : usersList.Skip((currentPage - 1) * pageSize).Take(pageSize);

    #endregion

    #region Events

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationState;
        userAuth = authState.User;

        isAdm = userAuth?.FindFirst(ClaimTypes.Role)?.Value == "Administrador" ? true : false;

        usersList = await api.GetAllUsers(); 
    }
    #endregion

    #region Methods

    

    private void Edit(long userId)
    {
        
    }

    private async Task Delete(long userId)
    {
        
        
        
    }

    

    

    private void ChangePage(int page)
    {
        currentPage = page;
    }

    #endregion
    

    
}
